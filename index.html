<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>LedsPhilipp Controller</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="darkred" />

    <!-- Styles -->
    <link rel="stylesheet" href="style.css" />

    <!-- Favicon -->
    <link rel="icon" href="icon-192.png" type="image/png" />
</head>
<body>
    <header>
        <h1>LedsPhilipp Control Panel</h1>
    </header>
    <main>
        <button id="connectBtn">Connect to LedsPhilipp</button>
        <div class="controls">
            <button id="toggleBtn" disabled>Toggle On/Off</button>
            
            <!-- Color Picker -->
            <div class="color-controls">
                <label for="colorPicker">Choose Color:</label>
                <input type="color" id="colorPicker" value="#ffffff" />
            </div>

            <div class="color-preview" id="colorPreview"></div>
            <button id="applyColorBtn" disabled>Apply Color</button>
        </div>
    </main>
    <footer>
        <p>©️2024 Control App by Daphne</p>
    </footer>

    <!-- Scripts -->
    <script>
        // Register the service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(err => {
                        console.error('Service Worker registration failed:', err);
                    });
            });
        }
    </script>
    <script>
        const serviceUuid = 'e2cfbe98-68fe-33cf-da9a-0464bc340004';
        const onOffCharUuid = 'd1bfad87-57ed-22de-c989-0353ab210003';
        const rgbCharUuid = 'f3dfcfa9-79ef-44bf-ebab-0575cd450005';

        let device = null;
        let server = null;
        let onOffCharacteristic = null;
        let rgbCharacteristic = null;

        const state = {
            isConnected: false,
            isOn: false,
            r: 255,
            g: 255,
            b: 255
        };

        const connectBtn = document.getElementById('connectBtn');
        const toggleBtn = document.getElementById('toggleBtn');
        const applyColorBtn = document.getElementById('applyColorBtn');
        const colorPicker = document.getElementById('colorPicker');
        const colorPreview = document.getElementById('colorPreview');

        // Convert hex color to RGB
        function hexToRgb(hex) {
            hex = hex.replace('#', '');
            let bigint = parseInt(hex, 16);
            let r = (bigint >> 16) & 255;
            let g = (bigint >> 8) & 255;
            let b = bigint & 255;
            return {r, g, b};
        }

        // Update the color preview box
        function updateColorPreview(r, g, b) {
            colorPreview.style.backgroundColor = `rgb(${r},${g},${b})`;
        }

        // Write to On/Off characteristic
        async function writeOnOff(value) {
            if (onOffCharacteristic) {
                const data = `${value ? 1 : 0}`;
                const encoder = new TextEncoder();
                await onOffCharacteristic.writeValue(encoder.encode(data));
            }
        }

        // Write to RGB characteristic
        async function writeColor(r, g, b) {
            if (rgbCharacteristic) {
                const colorString = `${r},${g},${b}`;
                const encoder = new TextEncoder();
                await rgbCharacteristic.writeValue(encoder.encode(colorString));
            }
        }

        // Connect to BLE device
        async function connectDevice() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'LedsPhilipp' }],
                    optionalServices: [serviceUuid]
                });
                server = await device.gatt.connect();
                const service = await server.getPrimaryService(serviceUuid);
                onOffCharacteristic = await service.getCharacteristic(onOffCharUuid);
                rgbCharacteristic = await service.getCharacteristic(rgbCharUuid);
                
                state.isConnected = true;
                toggleBtn.disabled = false;
                applyColorBtn.disabled = false;
                connectBtn.textContent = 'Connected';
            } catch (error) {
                console.error('Failed to connect:', error);
            }
        }

        // Event Handlers
        connectBtn.addEventListener('click', async () => {
            if (!state.isConnected) {
                await connectDevice();
            }
        });

        toggleBtn.addEventListener('click', async () => {
            state.isOn = !state.isOn;
            await writeOnOff(state.isOn);
            toggleBtn.textContent = state.isOn ? 'Turn Off' : 'Turn On';
            if (!state.isOn) {
                await writeColor(state.r, state.g, state.b);
            }
        });

        colorPicker.addEventListener('input', () => {
            const {r, g, b} = hexToRgb(colorPicker.value);
            updateColorPreview(r, g, b);
        });

        applyColorBtn.addEventListener('click', async () => {
            const {r, g, b} = hexToRgb(colorPicker.value);
            state.r = r;
            state.g = g;
            state.b = b;
            await writeColor(state.r, state.g, state.b);
        });

        // Initialize UI
        updateColorPreview(state.r, state.g, state.b);
    </script>
</body>
</html>
